@{
    ViewData["Title"] = "Category";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --bd-dark-blue-bg: rgb(5, 45, 100);
        --bs-white: rgb(255, 255, 255);
    }

    .custom-popover {
        --bs-popover-max-width: 500px;
        --bs-popover-border-color: var(--bd-dark-blue-bg);
        --bs-popover-header-bg: var(--bd-dark-blue-bg);
        --bs-popover-header-color: var(--bs-white);
        --bs-popover-body-padding-x: 20px;
        --bs-popover-body-padding-y: 20px;
    }
</style>

<nav class="mt-2" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">Mantenimiento</li>
        <li class="breadcrumb-item active" aria-current="page">Categorías de Insumos</li>
    </ol>
</nav>

<div class="card">
    <div class="card-header">
        <i class="fa-solid fa-table"></i> Categorías de Insumos Registradas
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                <button type="button" class="btn btn-success" onclick="Open_Form_Modal(null)">Insertar Categoría de
                    Insumo <i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <hr />

        <table id="Table_Categoria_Insumo" class="display cell-border" style="width: 100%">
            <thead>
                <tr>
                    <th>ID:</th>
                    <th>Nombre:</th>
                    <th>Estado:</th>
                    <th>Operaciones:</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<!--Vertically Centered Modal-->
<div class="modal fade" id="Form_Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"
    data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Categoría del Insumo</h1>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!----><input id="ID_Categoria_Insumo" type="hidden" value="0" /><!---->
                <div class="row g-2">
                    <div class="col-sm-6">
                        <label for="Estado_Categoria_Insumo" class="form-label">Estado:</label>
                        <select class="form-select" name="Estado_Categoria_Insumo" id="Estado_Categoria_Insumo"
                            aria-label="Default select example">
                            <option value="0" selected disabled>Seleccionar</option>
                            <option value="Available">Disponible</option>
                            <option value="Not_Available">No Disponible</option>
                        </select>
                    </div>
                    <div class="col-sm-6">
                        <label for="Nombre_Categoria_Insumo" class="form-label">Nombre:</label>
                        <input type="text" class="form-control" id="Nombre_Categoria_Insumo" placeholder="Nombre"
                            autocomplete="off">
                    </div>
                    <div class="col-sm-12">
                        <label for="Descripcion_Categoria_Insumo" class="form-label">Descripción:</label>
                        <textarea class="form-control" id="Descripcion_Categoria_Insumo" placeholder="Descripción"
                            autocomplete="off"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Procesar()">Procesar</button>
            </div>
        </div>
    </div>
</div>
<!--Vertically Centered Modal-->
@section Java_Script {
    <script>
        var Table_Categoria_Insumo;
        var Selected_Row;
        // jQuery.ajax({
        //     url: "@Url.Action("Management_Controller_Categoria_Insumo_Listar", "Management")",
        //     type: "GET",
        //     dataType: "json",
        //     contentType: "application/json; charset=UTF-8",
        //     success: function (data) {
        //         /*Good 'console.log'*/console.log(data);
        //     }
        // });

        $(document).ready(function () {
            Table_Categoria_Insumo = $("#Table_Categoria_Insumo").DataTable({
                fnDrawCallback: function () {
                    /**/
                    $(document).ready(function () {
                        $(".Pop_Trigger").popover({
                            trigger: "hover focus",
                            animation: true
                        });
                    });
                    /**/
                },
                responsive: true,
                ordering: false,
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.1.8/i18n/es-MX.json',
                },
                "ajax": {
                    url: "@Url.Action("Management_Controller_Categoria_Insumo_Listar", "Management")",
                    type: "GET",
                    dataType: "json"
                },
                "columns": [
                    { "data": "iD_Categoria_Insumo" },
                    {
                        "data": null, "render": function (data, type, row) {
                            return '<a tabindex="' + row.iD_Categoria_Insumo + '" href="#" class="Pop_Trigger" data-bs-custom-class="custom-popover" data-bs-container="body" data-bs-toggle="popover" data-bs-title="Descripción" data-bs-content="' + row.descripcion_Categoria_Insumo + '">' + row.nombre_Categoria_Insumo + '</a>';
                        }
                    },
                    {
                        "data": "estado_Categoria_Insumo", "render": function (estado_Categoria_Insumo) {
                            if (estado_Categoria_Insumo) {
                                return '<span class="badge text-bg-success">Disponible</span>';
                            } else {
                                return '<span class="badge text-bg-danger">No Disponible</span>';
                            }
                        }
                    },
                    {
                        "defaultContent": '<button type="button" class="btn btn-primary btn-sm Edit_Button"><i class="fa-solid fa-pencil"></i></button>' +
                            '<button type="button" class="btn btn-danger btn-sm ms-2 Delete_Button"><i class="fa-solid fa-trash"></i></button>',
                        "orderable": false,
                        "searchable": false,
                        "width": "90px"
                    }
                ]
            });
        });

        function Open_Form_Modal(data) {
            if (data == null) {
                $("#ID_Categoria_Insumo").val(0);
                $("#Nombre_Categoria_Insumo").val("");
                $("#Descripcion_Categoria_Insumo").val("");
                $("#Estado_Categoria_Insumo").val(0);
            } else {
                if (data != null) {
                    $("#ID_Categoria_Insumo").val(data.iD_Categoria_Insumo);
                    $("#Nombre_Categoria_Insumo").val(data.nombre_Categoria_Insumo);
                    $("#Descripcion_Categoria_Insumo").val(data.descripcion_Categoria_Insumo);
                    $("#Estado_Categoria_Insumo").val(data.estado_Categoria_Insumo == true ? "Available" : "Not_Available");
                }
            }
            $("#Form_Modal").modal("show");
        }

        function Selected_Row_Function(data) {
            var Selected_Row = $(data).parents("tr"); // Obtener la Fila Actual.
            if (Selected_Row.hasClass("child")) { // Compruebe si la Fila Actual es una Fila Secundaria.
                Selected_Row = Selected_Row.prev(); // Si es así, Señale la Fila Anterior. (It's "parent")
            }
            return Selected_Row;
        }

        $("#Table_Categoria_Insumo").on("click", '.Edit_Button', function () {
            Selected_Row = Selected_Row_Function(this);
            /**/
            var data = Table_Categoria_Insumo.row(Selected_Row).data();
            /**/
            // /*Good 'console.log'*/console.log(data);
            /**/
            Open_Form_Modal(data);
        });

        $("#Table_Categoria_Insumo").on("click", '.Delete_Button', function () {
            Selected_Row = Selected_Row_Function(this);
            /**/
            var data = Table_Categoria_Insumo.row(Selected_Row).data();
            /**/
            Swal.fire({
                title: "Confirmación",
                text: "¿Desea Eliminar la Categoría Seleccionada?",
                icon: "warning",
                showCancelButton: true,
                cancelButtonText: "Cancelar",
                cancelButtonColor: "#FF0000",
                confirmButtonText: "Eliminar",
                confirmButtonColor: "#3085D6"
            }).then((result) => {
                if (result.isConfirmed) {
                    jQuery.ajax({
                        url: "@Url.Action("Management_Controller_Categoria_Insumo_Eliminar", "Management")",
                        type: "DELETE",
                        data: { ID_Categoria_Insumo: data.iD_Categoria_Insumo },
                        success: function (data) {

                            // debugger;

                            if (data.result) {
                                Swal.fire({
                                    title: "Correcto",
                                    text: "La Categoría ha sido Eliminada",
                                    icon: "success"
                                });
                                Table_Categoria_Insumo.row(Selected_Row).remove().draw();
                            } else {
                                Swal.fire({
                                    title: "Error",
                                    text: data.message,
                                    icon: "error"
                                });
                                // alert(data.message);
                            }
                        },
                        error: function (error) {
                            alert(error);
                        }
                    });
                }
            });
            // /*Good 'console.log'*/console.log(data);
        });

        function Procesar() {
            var Estado_Categoria_Insumo_Selection = $("#Estado_Categoria_Insumo option:selected").text();

            var Categoria = {
                iD_Categoria_Insumo: $("#ID_Categoria_Insumo").val(),
                nombre_Categoria_Insumo: $("#Nombre_Categoria_Insumo").val(),
                descripcion_Categoria_Insumo: $("#Descripcion_Categoria_Insumo").val(),
                estado_Categoria_Insumo: $("#Estado_Categoria_Insumo").val() == "Available" ? true : false
            };

            if (Estado_Categoria_Insumo_Selection == "Seleccionar") {
                toastr.options = {
                    "closeButton": true,
                    "debug": false,
                    "newestOnTop": true,
                    "progressBar": true,
                    "positionClass": "toast-bottom-center",
                    "preventDuplicates": true,
                    "onclick": null,
                    "showDuration": "300",
                    "hideDuration": "1000",
                    "timeOut": "5000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                }
                toastr["warning"]("Campo Requerido: Estado de la Categoría del Insumo", "Advertencia:");
            } else {
                if ($("#ID_Categoria_Insumo").val() == 0) {
                    jQuery.ajax({
                        url: "@Url.Action("Management_Controller_Categoria_Insumo_Registrar", "Management")",
                        type: "POST",
                        data: { Obj_Class_Entity_Categoria_Insumo: Categoria },
                        success: function (data) {

                            // debugger;

                            $(".modal-body").LoadingOverlay("hide");

                            if (data.result != 0) {
                                Categoria.iD_Categoria_Insumo = data.result;
                                Table_Categoria_Insumo.row.add(Categoria).draw(false);
                                $("#Form_Modal").modal("hide");
                            } else {
                                toastr.options = {
                                    "closeButton": true,
                                    "debug": false,
                                    "newestOnTop": true,
                                    "progressBar": true,
                                    "positionClass": "toast-bottom-center",
                                    "preventDuplicates": true,
                                    "onclick": null,
                                    "showDuration": "300",
                                    "hideDuration": "1000",
                                    "timeOut": "5000",
                                    "extendedTimeOut": "1000",
                                    "showEasing": "swing",
                                    "hideEasing": "linear",
                                    "showMethod": "fadeIn",
                                    "hideMethod": "fadeOut"
                                }
                                toastr["warning"](data.message, "Advertencia:");
                            }
                        },
                        error: function (error) {
                            $(".modal-body").LoadingOverlay("hide");
                            alert(error);
                        },
                        beforeSend: function () {
                            $(".modal-body").LoadingOverlay("show", {
                                background: "rgba(0, 0, 0, 0.5)",
                                image: "../img/clock-regular.svg",
                                imageAnimation: "1.5s fadein",
                                imageAutoResize: true,
                                imageResizeFactor: 1,
                                imageColor: "rgb(255, 205, 0)"
                            });
                        }
                    });
                } else {
                    if ($("#ID_Categoria_Insumo").val() != 0) {
                        jQuery.ajax({
                            url: "@Url.Action("Management_Controller_Categoria_Insumo_Editar", "Management")",
                            type: "PUT",
                            data: { Obj_Class_Entity_Categoria_Insumo: Categoria },
                            success: function (data) {

                                // debugger;

                                $(".modal-body").LoadingOverlay("hide");

                                if (data.result) {
                                    Table_Categoria_Insumo.row(Selected_Row).data(Categoria).draw(false);
                                    Selected_Row = null;
                                    $("#Form_Modal").modal("hide");
                                } else {
                                    toastr.options = {
                                        "closeButton": true,
                                        "debug": false,
                                        "newestOnTop": true,
                                        "progressBar": true,
                                        "positionClass": "toast-bottom-center",
                                        "preventDuplicates": true,
                                        "onclick": null,
                                        "showDuration": "300",
                                        "hideDuration": "1000",
                                        "timeOut": "5000",
                                        "extendedTimeOut": "1000",
                                        "showEasing": "swing",
                                        "hideEasing": "linear",
                                        "showMethod": "fadeIn",
                                        "hideMethod": "fadeOut"
                                    }
                                    toastr["warning"](data.message, "Advertencia:");
                                }
                            },
                            error: function (error) {
                                $(".modal-body").LoadingOverlay("hide");
                                alert(error);
                            },
                            beforeSend: function () {
                                $(".modal-body").LoadingOverlay("show", {
                                    background: "rgba(0, 0, 0, 0.5)",
                                    image: "../img/clock-regular.svg",
                                    imageAnimation: "1.5s fadein",
                                    imageAutoResize: true,
                                    imageResizeFactor: 1,
                                    imageColor: "rgb(255, 205, 0)"
                                });
                            }
                        });
                    }
                }
            }
        }
    </script>
}